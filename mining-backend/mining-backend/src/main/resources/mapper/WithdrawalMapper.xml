<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.slb.mining_backend.modules.withdraw.mapper.WithdrawalMapper">

    <insert id="insert" parameterType="com.slb.mining_backend.modules.withdraw.entity.Withdrawal" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO withdrawals (user_id, amount, account_type, account_info, status, remark, currency, xmr_equivalent, rate_at_request, transfer_network, fee_amount, create_time, update_time)
        VALUES (#{userId}, #{amount}, #{accountType}, #{accountInfo}, #{status}, #{remark},
                #{currency}, #{xmrEquivalent}, #{rateAtRequest}, #{transferNetwork}, #{feeAmount}, NOW(), NOW())
    </insert>

    <select id="findByIdAndUserId" resultType="com.slb.mining_backend.modules.withdraw.entity.Withdrawal">
        SELECT * FROM withdrawals WHERE id = #{id} AND user_id = #{userId}
    </select>

    <update id="update" parameterType="com.slb.mining_backend.modules.withdraw.entity.Withdrawal">
        UPDATE withdrawals
        <set>
            <if test="status != null">status = #{status},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="transactionId != null">transaction_id = #{transactionId},</if>
            <if test="currency != null">currency = #{currency},</if>
            <if test="xmrEquivalent != null">xmr_equivalent = #{xmrEquivalent},</if>
            <if test="rateAtRequest != null">rate_at_request = #{rateAtRequest},</if>
            <if test="transferNetwork != null">transfer_network = #{transferNetwork},</if>
            <if test="feeAmount != null">fee_amount = #{feeAmount},</if>
            <if test="reviewTime != null">review_time = #{reviewTime},</if>
            <if test="reviewedBy != null">reviewed_by = #{reviewedBy},</if>
            update_time = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <select id="countByUserIdAndStatus" resultType="long">
        SELECT count(*) FROM withdrawals
        WHERE user_id = #{userId}
        <if test="status != null">
            AND status = #{status}
        </if>
    </select>

    <select id="findByUserIdAndStatusPaginated" resultType="com.slb.mining_backend.modules.withdraw.entity.Withdrawal">
        SELECT * FROM withdrawals
        WHERE user_id = #{userId}
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{size}
    </select>

    <select id="countTodayWithdrawalsByUserId" resultType="long">
        SELECT count(*) FROM withdrawals
        WHERE user_id = #{userId} AND create_time >= CURDATE()
    </select>

    <select id="countActiveByUserId" resultType="long">
        SELECT COUNT(*)
        FROM withdrawals
        WHERE user_id = #{userId}
          AND status = 0
    </select>

    <select id="findById" resultType="com.slb.mining_backend.modules.withdraw.entity.Withdrawal">
        SELECT * FROM withdrawals
        WHERE id = #{withdrawalId}
    </select>

    <!-- 在 WithdrawalMapper.xml 中添加新查询 -->
    <select id="findByStatusPaginated" resultType="com.slb.mining_backend.modules.withdraw.entity.Withdrawal">
        SELECT * FROM withdrawals
        WHERE status = #{status}
        ORDER BY create_time ASC
            LIMIT #{offset}, #{size}
    </select>

    <select id="countByStatus" resultType="long">
        SELECT count(*) FROM withdrawals
        WHERE status = #{status}
    </select>

    <select id="countByFilters" resultType="long">
        SELECT count(*)
        FROM withdrawals
        <where>
            <if test="status != null">
                status = #{status}
            </if>
            <if test="userId != null">
                AND user_id = #{userId}
            </if>
            <if test="startTime != null and startTime != ''">
                AND create_time <![CDATA[>=]]> #{startTime}
            </if>
            <if test="endTime != null and endTime != ''">
                AND create_time <![CDATA[<]]> #{endTime}
            </if>
        </where>
    </select>

    <select id="findByFiltersPaginated" resultType="com.slb.mining_backend.modules.withdraw.entity.Withdrawal">
        SELECT *
        FROM withdrawals
        <where>
            <if test="status != null">
                status = #{status}
            </if>
            <if test="userId != null">
                AND user_id = #{userId}
            </if>
            <if test="startTime != null and startTime != ''">
                AND create_time <![CDATA[>=]]> #{startTime}
            </if>
            <if test="endTime != null and endTime != ''">
                AND create_time <![CDATA[<]]> #{endTime}
            </if>
        </where>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{size}
    </select>

</mapper>