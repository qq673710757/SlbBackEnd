<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.slb.mining_backend.modules.device.mapper.DeviceGpuHashrateReportMapper">

    <!--
      幂等 upsert：
      - 唯一键 uq_device_gpu_bucket(device_id, gpu_index, bucket_time) 保证同一分钟同一 GPU 只有一条；
      - 网络重试/并发上报会覆盖该分钟桶的最新数据。
    -->
    <insert id="upsertMinuteReport" parameterType="com.slb.mining_backend.modules.device.entity.DeviceGpuHashrateReport"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO device_gpu_hashrate_reports
        (user_id, device_id, gpu_index, gpu_name, hashrate_mhs, algorithm, bucket_time, created_time)
        VALUES
        (#{userId}, #{deviceId}, #{gpuIndex}, #{gpuName}, #{hashrateMhs}, #{algorithm}, #{bucketTime}, NOW())
        ON DUPLICATE KEY UPDATE
            user_id = VALUES(user_id),
            gpu_name = VALUES(gpu_name),
            hashrate_mhs = VALUES(hashrate_mhs),
            algorithm = VALUES(algorithm),
            created_time = NOW()
    </insert>

    <select id="selectByDeviceSince" resultType="com.slb.mining_backend.modules.device.entity.DeviceGpuHashrateReport">
        SELECT
            id,
            user_id AS userId,
            device_id AS deviceId,
            gpu_index AS gpuIndex,
            gpu_name AS gpuName,
            hashrate_mhs AS hashrateMhs,
            algorithm,
            bucket_time AS bucketTime,
            created_time AS createdTime
        FROM device_gpu_hashrate_reports
        WHERE user_id = #{userId}
          AND device_id = #{deviceId}
          AND bucket_time &gt;= #{since}
        ORDER BY bucket_time ASC
    </select>

    <select id="selectLatestByUser" resultType="com.slb.mining_backend.modules.device.vo.DeviceGpuHashrateSnapshotVo">
        SELECT
            r.device_id AS deviceId,
            d.device_name AS deviceName,
            r.gpu_index AS gpuIndex,
            r.gpu_name AS gpuName,
            r.hashrate_mhs AS hashrate,
            r.algorithm AS algorithm,
            r.bucket_time AS bucketTime
        FROM device_gpu_hashrate_reports r
        INNER JOIN (
            SELECT device_id, gpu_index, MAX(bucket_time) AS max_time
            FROM device_gpu_hashrate_reports
            WHERE user_id = #{userId}
              AND bucket_time &gt;= #{cutoffTime}
            GROUP BY device_id, gpu_index
        ) latest
            ON r.device_id = latest.device_id
           AND r.gpu_index = latest.gpu_index
           AND r.bucket_time = latest.max_time
        INNER JOIN devices d ON d.id = r.device_id
        WHERE r.user_id = #{userId}
          AND d.is_deleted = 0
          AND d.status = 1
          AND (d.last_online_time IS NULL OR d.last_online_time &gt;= #{cutoffTime})
        ORDER BY r.device_id ASC, r.gpu_index ASC
    </select>

    <select id="sumLatestHashrateByAlgorithm" resultType="com.slb.mining_backend.modules.device.vo.GpuAlgorithmHashrateVo">
        SELECT
            r.algorithm AS algorithm,
            SUM(r.hashrate_mhs) AS totalHashrate
        FROM device_gpu_hashrate_reports r
        INNER JOIN (
            SELECT device_id, gpu_index, MAX(bucket_time) AS max_time
            FROM device_gpu_hashrate_reports
            WHERE user_id = #{userId}
              AND bucket_time &gt;= #{cutoffTime}
            GROUP BY device_id, gpu_index
        ) latest
            ON r.device_id = latest.device_id
           AND r.gpu_index = latest.gpu_index
           AND r.bucket_time = latest.max_time
        INNER JOIN devices d ON d.id = r.device_id
        WHERE r.user_id = #{userId}
          AND r.algorithm IS NOT NULL
          AND r.algorithm &lt;&gt; ''
          AND r.bucket_time &gt;= #{cutoffTime}
          AND d.is_deleted = 0
          AND d.status = 1
          AND (d.last_online_time IS NULL OR d.last_online_time &gt;= #{cutoffTime})
        GROUP BY r.algorithm
    </select>

</mapper>
