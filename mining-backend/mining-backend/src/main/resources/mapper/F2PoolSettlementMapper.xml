<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.slb.mining_backend.modules.xmr.mapper.F2PoolSettlementMapper">

    <resultMap id="F2PoolSettlementResultMap" type="com.slb.mining_backend.modules.xmr.entity.F2PoolSettlement">
        <id property="id" column="id"/>
        <result property="account" column="account"/>
        <result property="coin" column="coin"/>
        <result property="payoutDate" column="payout_date"/>
        <result property="grossAmountCoin" column="gross_amount_coin"/>
        <result property="grossAmountCal" column="gross_amount_cal"/>
        <result property="calRate" column="cal_rate"/>
        <result property="rateSource" column="rate_source"/>
        <result property="poolScore" column="pool_score"/>
        <result property="feeRate" column="fee_rate"/>
        <result property="feeCal" column="fee_cal"/>
        <result property="netCal" column="net_cal"/>
        <result property="status" column="status"/>
        <result property="reconcileStatus" column="reconcile_status"/>
        <result property="createdTime" column="created_time"/>
        <result property="updatedTime" column="updated_time"/>
    </resultMap>

    <insert id="insert" parameterType="com.slb.mining_backend.modules.xmr.entity.F2PoolSettlement" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO f2pool_settlement
        (account, coin, payout_date, gross_amount_coin, gross_amount_cal, cal_rate, rate_source, pool_score,
         fee_rate, fee_cal, net_cal, status, reconcile_status, created_time, updated_time)
        VALUES
        (#{account}, #{coin}, #{payoutDate}, #{grossAmountCoin}, #{grossAmountCal}, #{calRate}, #{rateSource}, #{poolScore},
         #{feeRate}, #{feeCal}, #{netCal}, #{status}, #{reconcileStatus}, #{createdTime}, #{updatedTime})
    </insert>

    <select id="selectById" resultMap="F2PoolSettlementResultMap">
        SELECT *
        FROM f2pool_settlement
        WHERE id = #{id}
    </select>

    <select id="selectByAccountAndDate" resultMap="F2PoolSettlementResultMap">
        SELECT *
        FROM f2pool_settlement
        WHERE account = #{account}
          AND coin = #{coin}
          AND payout_date = #{payoutDate}
        LIMIT 1
    </select>

    <update id="updateStatus">
        UPDATE f2pool_settlement
        SET status = #{status},
            updated_time = #{updatedTime}
        WHERE id = #{id}
    </update>

    <update id="updateReconcileStatus">
        UPDATE f2pool_settlement
        SET reconcile_status = #{reconcileStatus},
            updated_time = #{updatedTime}
        WHERE id = #{id}
    </update>

    <select id="countByStatus" resultType="long">
        SELECT COUNT(1)
        FROM f2pool_settlement
        WHERE status = #{status}
    </select>

    <select id="findByStatusPaginated" resultMap="F2PoolSettlementResultMap">
        SELECT *
        FROM f2pool_settlement
        WHERE status = #{status}
        ORDER BY payout_date DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="countDistinctPayoutDates" resultType="long">
        SELECT COUNT(DISTINCT payout_date)
        FROM f2pool_settlement
        <where>
            status = #{status}
            <if test="startDate != null">
                AND payout_date <![CDATA[>=]]> #{startDate}
            </if>
            <if test="endDate != null">
                AND payout_date <![CDATA[<=]]> #{endDate}
            </if>
        </where>
    </select>

    <select id="listDistinctPayoutDates" resultType="java.time.LocalDate">
        SELECT DISTINCT payout_date
        FROM f2pool_settlement
        <where>
            status = #{status}
            <if test="startDate != null">
                AND payout_date <![CDATA[>=]]> #{startDate}
            </if>
            <if test="endDate != null">
                AND payout_date <![CDATA[<=]]> #{endDate}
            </if>
        </where>
        ORDER BY payout_date DESC
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="listGrantRowsByPayoutDates" resultType="com.slb.mining_backend.modules.admin.vo.EarningsGrantRow">
        SELECT
            payout_date AS payoutDate,
            coin AS coin,
            COALESCE(SUM(gross_amount_coin), 0) AS grossAmountCoin,
            COALESCE(SUM(CASE
                WHEN cal_rate IS NOT NULL AND cal_rate > 0 THEN COALESCE(fee_cal, 0) / cal_rate
                ELSE 0
            END), 0) AS commissionCoin,
            MAX(updated_time) AS updatedTime
        FROM f2pool_settlement
        WHERE status = #{status}
          AND payout_date IN
        <foreach collection="dates" item="date" open="(" separator="," close=")">
            #{date}
        </foreach>
        GROUP BY payout_date, coin
        ORDER BY payout_date DESC
    </select>

</mapper>
